# References:
## https://github.com/marketplace/actions/merge-conflict-finder
## https://blog.marcnuri.com/triggering-github-actions-across-different-repositories
## https://github.com/marketplace/actions/merge-branch

name: New Release â€¢â€¢ ðŸš€ â€¢â€¢

on:
  workflow_dispatch:
    inputs:
      release:
        type: choice
        description: Release environemnt (If release is production build-type option will be ignored)
        required: true
        options:
          - beta
          - production
      build-type:
        type: choice
        description: Build type
        required: true
        options:
          - build
          - revision
          - minor
          - major
env:
  version-number: "0"

jobs:
  sync-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Check if mergeable â€¢â€¢ ðŸš€ â€¢â€¢
        uses: codex-/return-dispatch@v1
        id: return_dispatch
        with:
          token: ${{ secrets.ACCESS_TOKEN }}
          ref: refs/heads/${{ github.event.inputs.release }}
          repo: repo2
          owner: gemerich
          workflow: new-release.yml
      - name: Await Run ID ${{ steps.return_dispatch.outputs.run_id }}
        uses: Codex-/await-remote-run@v1.0.0
        with:
          token: ${{ secrets.ACCESS_TOKEN }}
          repo: repo2
          owner: gemerich
          run_id: ${{ steps.return_dispatch.outputs.run_id }}
          run_timeout_seconds: 300 # Optional
          poll_interval_ms: 5000 # Optional
  sync-branch2:
    runs-on: ubuntu-latest
    steps:
      - name: Check if mergeable
        uses: codex-/return-dispatch@v1
        id: return_dispatch
        with:
          token: ${{ secrets.ACCESS_TOKEN }}
          ref: refs/heads/${{ github.event.inputs.release }}
          repo: repo2
          owner: gemerich
          workflow: new-release.yml
      - name: Await Run ID ${{ steps.return_dispatch.outputs.run_id }}
        uses: Codex-/await-remote-run@v1.0.0
        with:
          token: ${{ secrets.ACCESS_TOKEN }}
          repo: repo2
          owner: gemerich
          run_id: ${{ steps.return_dispatch.outputs.run_id }}
          run_timeout_seconds: 300 # Optional
          poll_interval_ms: 5000 # Optional
  merge-branches:
    needs: [sync-branch, sync-branch2]
    runs-on: ubuntu-latest
    steps:
      - name: Merges branches â€¢â€¢ ðŸš€ â€¢â€¢
        uses: codex-/return-dispatch@v1
        id: return_dispatch
        with:
          token: ${{ secrets.ACCESS_TOKEN }}
          ref: ${{ github.ref }}
          repo: repo2
          owner: gemerich
          workflow: merge-beta.yml
      - name: Await Run ID ${{ steps.return_dispatch.outputs.run_id }}
        uses: Codex-/await-remote-run@v1.0.0
        with:
          token: ${{ secrets.ACCESS_TOKEN }}
          repo: repo2
          owner: gemerich
          run_id: ${{ steps.return_dispatch.outputs.run_id }}
          run_timeout_seconds: 300 # Optional
          poll_interval_ms: 5000 # Optional
  execute-tagging:
    needs: [merge-branches]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: beta
      - name: Set environment variables from project settings
        run: |
          exec .github/scripts/run.sh ${{ github.event.inputs.release }} ${{ github.event.inputs.build-type }}
      - name: Get version number
        run: echo "version-number=$(cat ./package.json | grep -m 1 version | sed 's/[^0-9.]//g')" >> $GITHUB_ENV
      - name: Test
        run: echo ${{ env.version-number }}
      - uses: fregante/setup-git-token@v1
        with:
          token: ${{ secrets.ACCESS_TOKEN }}
          name: "Gemerich"
          email: gustavo@diviproject.org
      - name: Create release branch
        run: | 
          git checkout --track release/${{ env.version-number }}
          git pull
      - uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: Bump to ${{ env.version-number }}
          file_pattern: |
            package.json
      - name: Push new branch
        run: git push origin release/${{ env.version-number }}
      - name: Create pull request release -> beta
        env:
          GH_TOKEN: ${{ secrets.ACCESS_TOKEN }}
        run: |
          nl=$'\n'
          body="Hi @${{ github.actor }}! ${nl}This PR was created in response to a manual trigger of the release workflow here: \
          https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}. ${nl}"
          gh pr create --title "Release ${{ env.version-number }} release -> beta" --body "$body" --label release --base beta --head release/${{ env.version-number }}
      - name: Approve PR
        run: |
          gh pr review release/${{ env.version-number }} --approve

      - name: Merge release -> beta
        run: |
          gh pr merge release/${{ env.version-number }} --delete-branch --merge
          
      - name: Create pull request beta -> development
        run: |
          nl=$'\n'
          body="Hi @${{ github.actor }}! ${nl}This PR was created in response to a manual trigger of the release workflow here: \
          https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}. ${nl}"
          gh pr create --title "Release ${{ env.version-number }} beta -> development" --body "$body" --label release --base development --head release/${{ env.version-number }}
      - name: Approve PR
        run: |
          gh pr review release/${{ env.version-number }} --approve

      - name: Merge release -> beta
        run: |
          gh pr merge release/${{ env.version-number }} --merge

      # - name: Merge release -> beta
      #   run: |
      #     git checkout beta         
      #     git tag "v-${{ github.event.inputs.build-type }}-release-${{ env.version-number }}"
      #     git push origin --tags

      # - name: Test
      #   run: |
      #     git checkout development
      #     git merge beta
      #     git push --force https://${{ secrets.ACCESS_TOKEN }}@github.com/Gemerich/repo1.git
  update-version-other-repos:
    needs: [sync-branch, sync-branch2, execute-tagging]
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.release }}
      url: "${{ github.event.inputs.release }} === beta ? http://asd.com : http://aaa.com"
    steps:
      - name: Merges branches â€¢â€¢ ðŸš€ â€¢â€¢
        uses: codex-/return-dispatch@v1
        id: return_dispatch
        with:
          token: ${{ secrets.ACCESS_TOKEN }}
          ref: ${{ github.ref }}
          repo: repo2
          owner: gemerich
          workflow: final-step.yml
          workflow_inputs: '{ "version_number": "${{ github.event.inputs.version-number }}", { "release": "${{ github.event.inputs.release }}" }}'
      - name: Await Run ID ${{ steps.return_dispatch.outputs.run_id }}
        uses: Codex-/await-remote-run@v1.0.0
        with:
          token: ${{ secrets.ACCESS_TOKEN }}
          repo: repo2
          owner: gemerich
          run_id: ${{ steps.return_dispatch.outputs.run_id }}
          run_timeout_seconds: 300 # Optional
          poll_interval_ms: 5000 # Optional
